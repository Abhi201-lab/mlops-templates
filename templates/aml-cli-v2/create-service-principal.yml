# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

parameters:
- name: sp_name
  type: string

steps:
  - task: AzureCLI@2
    displayName: Create Service Principal
    continueOnError: true
    inputs: 
      azureSubscription: $(ado_service_connection_rg) #needs to have access at the RG level 
      scriptType: bash
      workingDirectory: $(System.DefaultWorkingDirectory)
      scriptLocation: inlineScript
      inlineScript: |
      echo "Creating service principal ${{ parameters.sp_name }}"
      read -d "" clientId clientSecret tenantId <<< $(az ad sp create-for-rbac --name ${{ parameters.sp_name }} --role "Contributor" --scopes /subscriptions/$(subscription_id) --query "[appId, password, tenant]" -o tsv)
      spId=$(az ad sp list --display-name ${{ parameters.sp_name }} --query [].id -o tsv)
      az synapse role assignment create --workspace-name $(synapse_workspace_name) --role "Synapse Contributor" --assignee ${spId} --scope workspaces/$(synapse_workspace_name)
      echo "##vso[task.setvariable variable=service_principal_id;]$spId"
      echo "##vso[task.setvariable variable=service_principal_secret;]$clientSecret"
      echo "##vso[task.setvariable variable=tenant_id;]$tenantId"
      JSON_STRING=$'{\n\t"service_principal_id": "%s",\n\t"resource_group": "%s",\n\t"tenant_id": "%s"\n}'
      printf "$JSON_STRING" "$spId" "$(resource_group)" "$tenantId"
